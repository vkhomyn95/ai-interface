<!DOCTYPE html>
<html lang="en">

{% include 'head.html' %}

<body>

{% include 'header/header-top.html' %}

{% with messages = get_flashed_messages() %}
{% if messages %}
{% for message in messages %}
    {% include 'toast.html' %}
{% endfor %}
{% endif %}
{% endwith %}

<div class="container">

    {% include 'header/header-left.html' %}

    <div class="container-main">
        <div class="breadcrumb">
            {% if is_profile %}
                <a class="breadcrumb-navigation flex flex-align-center" href="{{ url_for('bases.bases_blp.dashboard') }}">
                 {% include 'header/icons/icon-breadcrumb.html' %}
                </a>
            {% else %}
                <a class="breadcrumb-navigation flex flex-align-center" href="{{ url_for('bases.bases_blp.users') }}">
                    {% include 'header/icons/icon-breadcrumb.html' %}
                </a>
            {% endif %}
            <div class="breadcrumb-heading flex flex-align-center">
                <div class="breadcrumb-heading-previous ml-15">
                    {% if is_profile %}
                        Мій профіль
                    {% else %}
                        Користувачі
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="content">
            <form
                    method="POST"
                    id="userForm"
                    class="mange-wrapper"
                    action="{% if not user.id %}{{ url_for('bases.bases_blp.create_user') }}{% else %}{{ url_for('bases.bases_blp.user', user_id=user.id) }}{% endif %}">

                <div class="card">
                    <div class="p-20">
                        <span class="card-title">
                            Користувач
                        </span>
                    </div>
                    <div class="card-border"></div>
                    <div class="card-body">
                        <div class="card-body-wrapper p-20">

                            <input class="input is-success" type="hidden" id="user_id" name="id" value="{{ user.id }}">
                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="username">Логін</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="username"
                                            name="username"
                                            placeholder="Логін"
                                            value="{{ user.username if user and user.username else '' }}"
                                            oninput="validateField(this)"
                                            {% if user.id is not none %}
                                                {% if user.id > 0 %}
                                                    readonly
                                                {% endif %}
                                            {% endif %}
                                    />
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="last_name">Прізвище</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="last_name"
                                            name="last_name"
                                            placeholder="Прізвище"
                                            value="{{ user.last_name if user and user.last_name else ''  }}"
                                            oninput="validateField(this)"
                                    />
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="first_name">Ім'я</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="first_name"
                                            name="first_name"
                                            placeholder="Ім'я"
                                            value="{{ user.first_name if user and user.first_name else '' }}"
                                            oninput="validateField(this)"
                                    />
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="email">Email</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="email"
                                            name="email"
                                            placeholder="Email"
                                            value="{{ user.email if user and user.email else '' }}"
                                            oninput="validateField(this)"
                                            {% if user.id is not none %}
                                                {% if user.id > 0 %}
                                                    readonly
                                                {% endif %}
                                            {% endif %}

                                    />
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="phone">Телефон</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="phone"
                                            name="phone"
                                            placeholder="Телефон"
                                            value="{{ user.phone if user and user.phone else '' }}"
                                            oninput="validateField(this)"
                                    />
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="phone">API ключ</label>
                                <div class="flex flex-direction-row  w-100">
                                    <div class="w-100">
                                        <input
                                                class="input"
                                                type="text"
                                                id="api_key"
                                                name="api_key"
                                                placeholder="Api key"
                                                value="{{ user.api_key if user and user.api_key else ''  }}"
                                                oninput="validateField(this)"
                                        />
                                    </div>
                                    <div class="tag-button" onclick="generateUrlSafe32()">
                                        {% include 'header/icons/icon-key.html' %}
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="password">Пароль</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="password"
                                            name="password"
                                            placeholder="Приховано"
                                            oninput="validatePassword(this)"
                                            autocomplete="off"
                                    />
                                </div>
                            </div>

                            <div class="flex flex-direction-row flex-align-center mb-20">
                                <label class="label label-required_danger" for="audience">Домен</label>
                                <div class="w-100">
                                    <input
                                            class="input"
                                            type="text"
                                            id="audience"
                                            name="audience"
                                            value="{{ user.audience if user and user.audience else '' }}"
                                            placeholder="voiptime.net"
                                            oninput="validateField(this)"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card ml-15">
                    <div class="p-20">
                        <span class="card-title">
                            Ліцензія
                        </span>
                    </div>
                    <div class="card-border"></div>
                    <div class="card-body">
                        <div class="card-body-wrapper">
                            <div class="p-20">
                                <div class="flex flex-direction-row flex-align-center mb-20">
                                    <label class="label label-required_danger">Активна</label>
                                    <div class="w-100">
                                <span id="toggleActive">
                                    {% if user.tariff.active %}
                                        <span onclick="toggleUserActive(true)">
                                            {% include 'header/icons/icon-square-checked.html' %}
                                            <input type="hidden" id="activeChecked" name="active" value="True">
                                        </span>
                                    {% else %}
                                        <span onclick="toggleUserActive(false)">
                                            {% include 'header/icons/icon-square.html' %}
                                            <input type="hidden" id="activeNotChecked" name="active" value="False">
                                        </span>
                                    {% endif %}
                                </span>
                                    </div>
                                </div>

                                <div class="flex flex-direction-row flex-align-center mb-20">
                                    <label class="label label-required_danger" for="total">Загалом</label>
                                    <div class="w-100">
                                        {% if current_user.role.name=='admin' %}
                                        <input
                                                class="input"
                                                type="number"
                                                id="total"
                                                name="total"
                                                value="{{ user.tariff.total }}"
                                                placeholder="1000"
                                                oninput="validateFieldLength(this, 1)"
                                        />
                                        {% else %}
                                        <div>
                                            {{ user.tariff.total }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="p-20">
                                <span class="card-title">
                                    Налаштування
                                </span>
                            </div>
                            <div class="card-border mb-40"></div>
                            <div class="flex flex-direction-row tabs">
                                <div class="interim-tab-header tab is-active" onclick="changeRecognitionTab(this, 'interim')">
                                    <div class="flex flex-direction-row flex-align-center mb-10">
                                        <div class="icon is-small">
                                            {% include 'header/icons/icon-configuration.html' %}
                                        </div>
                                        <div class="ml-15">Конфігурації</div>
                                    </div>
                                </div>
                                <div class="voice-tab-header tab ml-40" onclick="changeRecognitionTab(this, 'voice')">
                                    <div class="flex flex-direction-row flex-align-center mb-10">
                                        <div class="icon is-small">
                                            {% include 'header/icons/icon-voice.html' %}
                                        </div>
                                        <div class="ml-15">Голос</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-border"></div>
                            <div class="p-20">
                            <div class="interim-tab">
                                <div class="flex flex-direction-row flex-align-center mb-20">
                                    <label class="label label-required_danger" for="total">Максимальна тривалість інтервалу</label>
                                    <div class="w-100">
                                        <input
                                                class="input"
                                                type="number"
                                                id="interval_length"
                                                name="interval_length"
                                                value="{{ user.recognition.interval_length if user and user.recognition.interval_length else 2 }}"
                                                min="1"
                                                max="5"
                                                placeholder="2"
                                                onKeyUp="if(this.value>5){this.value='5';}else if(this.value<0){this.value='1';}"
                                        />
                                    </div>
                                </div>

                                <div class="flex flex-direction-row flex-align-center mb-20">
                                    <label class="label label-required_danger" for="total">Кількість спроб розпізнавання</label>
                                    <div class="w-100">
                                        <input
                                                class="input"
                                                type="number"
                                                id="predictions"
                                                name="predictions"
                                                placeholder="2"
                                                min="1"
                                                max="5"
                                                onKeyUp="if(this.value>5){this.value='5';}else if(this.value<0){this.value='1';}"
                                                value="{{ user.recognition.predictions if user and user.recognition.predictions else 2  }}"
                                        />
                                    </div>
                                </div>

                                <div class="flex flex-direction-row flex-align-center">
                                    <div class="mr-4" style="width: 60px">
                                        <input
                                                class="input is-small"
                                                id="rowIntervalSize"
                                                type="number"
                                                min="1"
                                                max="5"
                                                placeholder="2"
                                                onKeyUp="if(this.value>5){this.value='5';}else if(this.value<0){this.value='1';}"
                                        >
                                    </div>
                                    <div class="interval-button" onclick="addRowToTable()">
                                        Додати інтервал
                                    </div>
                                </div>
                                <div class="table w-100" id="table">
                                </div>
                            </div>
                            <div class="voice-tab is-hidden">
                                <div class="flex flex-direction-row flex-align-center mb-20">
                                    <label class="label label-required_danger" for="total">Частота (Hz)</label>
                                    <div class="w-100">
                                        <input
                                                class="input"
                                                type="number"
                                                id="rate"
                                                name="rate"
                                                value="{{ user.recognition.rate if user and user.recognition.rate else 8000 }}"
                                                placeholder="8000"
                                        />
                                    </div>
                                </div>
                                <div class="flex flex-direction-row flex-align-center mb-20">
                                    <label class="label label-required_danger" for="total">Формат кодування голосу</label>
                                    <div class="w-100">
                                        <input
                                                class="input"
                                                type="text"
                                                id="encoding"
                                                name="encoding"
                                                value="{{ user.recognition.encoding if user and user.recognition.encoding else 'slin' }}"
                                                placeholder="slin"
                                        />
                                    </div>
                                </div>
                            </div>

                        </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="footer">
            <div class="footer-wrapper">
                {% if is_profile and current_user.role.name=='admin' or current_user.role.name=='guest'%}
                    <button onclick="window.location.href = '/dashboard'" class="button button-secondary is-link">
                        Скасувати
                    </button>
                {% else %}
                    <button onclick="window.location.href = '/users'" class="button button-secondary is-link">
                        Скасувати
                    </button>
                {% endif %}
                <button onclick="saveForm()" class="button button-primary ml-10">
                    <svg width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="button-svg"><path d="M17.1522 7.25833L13.1272 3.23333C12.6588 2.76436 12.0233 2.50058 11.3605 2.5H5.3855C4.72246 2.5 4.08657 2.76339 3.61773 3.23223C3.14889 3.70107 2.8855 4.33696 2.8855 5V15C2.8855 15.663 3.14889 16.2989 3.61773 16.7678C4.08657 17.2366 4.72246 17.5 5.3855 17.5H15.3855C16.0485 17.5 16.6844 17.2366 17.1533 16.7678C17.6221 16.2989 17.8855 15.663 17.8855 15V9.025C17.8849 8.36218 17.6211 7.72672 17.1522 7.25833ZM8.71883 15.8333V14.1667H12.0522V15.8333H8.71883ZM16.2188 15C16.2188 15.221 16.131 15.433 15.9748 15.5893C15.8185 15.7455 15.6065 15.8333 15.3855 15.8333H13.7188V13.3333C13.7188 13.1123 13.631 12.9004 13.4748 12.7441C13.3185 12.5878 13.1065 12.5 12.8855 12.5H7.8855C7.66448 12.5 7.45252 12.5878 7.29624 12.7441C7.13996 12.9004 7.05216 13.1123 7.05216 13.3333V15.8333H5.3855C5.16448 15.8333 4.95252 15.7455 4.79624 15.5893C4.63996 15.433 4.55216 15.221 4.55216 15V5C4.55216 4.77899 4.63996 4.56702 4.79624 4.41074C4.95252 4.25446 5.16448 4.16667 5.3855 4.16667H7.05216V8.33333C7.05216 8.55435 7.13996 8.76631 7.29624 8.92259C7.45252 9.07887 7.66448 9.16667 7.8855 9.16667H11.2188C11.4398 9.16667 11.6518 9.07887 11.8081 8.92259C11.9644 8.76631 12.0522 8.55435 12.0522 8.33333C12.0522 8.11232 11.9644 7.90036 11.8081 7.74408C11.6518 7.5878 11.4398 7.5 11.2188 7.5H8.71883V4.16667H11.3605C11.5811 4.16974 11.7925 4.25606 11.9522 4.40833L15.9772 8.43333C16.0544 8.5112 16.1155 8.60355 16.157 8.70508C16.1984 8.80661 16.2195 8.91533 16.2188 9.025V15Z" fill="#252525"></path></svg>
                    <span class="ml-10">Зберегти</span>
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    function changeRecognitionTab(el, tab) {
        el.classList.add("is-active");
        if (tab === 'interim') {
            document.querySelector(".voice-tab-header").classList.remove("is-active");
            // document.querySelector(".integration-tab-header").classList.remove("is-active");
            document.querySelector(".interim-tab").classList.remove("is-hidden");
            // document.querySelector(".integration-tab").classList.add("is-hidden");
            document.querySelector(".voice-tab").classList.add("is-hidden");
        }
        if (tab === 'voice') {
            document.querySelector(".interim-tab").classList.add("is-hidden");
            // document.querySelector(".integration-tab-header").classList.remove("is-active");
            document.querySelector(".voice-tab").classList.remove("is-hidden");
            // document.querySelector(".integration-tab").classList.add("is-hidden");
            document.querySelector(".interim-tab-header").classList.remove("is-active");
        }
        if (tab === 'integration') {
            document.querySelector(".interim-tab").classList.add("is-hidden");
            // document.querySelector(".integration-tab").classList.remove("is-hidden");
            document.querySelector(".interim-tab-header").classList.remove("is-active");
            document.querySelector(".voice-tab").classList.add("is-hidden");
            document.querySelector(".voice-tab-header").classList.remove("is-active");
            document.querySelector(".interim-tab-header").classList.remove("is-active");
        }
    }

    function validatePassword(event) {
        const userId = +document.getElementById("user_id").value;
        if (userId === 0 || event.value.length >= 1) {
            return validateField(event)
        }
        return true
    }

    function validateUserForm() {
        /**
         * User form validation */
        let isValid = true;

        let username = document.getElementById("username");
        isValid = validateField(username);
        if (!isValid)
            return;
        let firstName = document.getElementById("first_name");
        isValid = validateField(firstName);
        if (!isValid)
            return;
        let lastName = document.getElementById("last_name");
        isValid = validateField(lastName);
        if (!isValid)
            return;
        let email = document.getElementById("email");
        isValid = validateField(email);
        if (!isValid)
            return;
        let phone = document.getElementById("phone");
        isValid = validateField(phone);
        if (!isValid)
            return;
        let apiKey = document.getElementById("api_key");
        isValid = validateField(apiKey);
        if (!isValid)
            return;
        let password = document.getElementById("password");
        if (!isValid)
            return;
        isValid = validatePassword(password);
        if (!isValid)
            return;
        let audience = document.getElementById("audience");
        isValid = validateField(audience);
        if (isValid)
            document.getElementById("userForm").submit();
    }

    function validateField(field) {
        /**
         * User field validation */
        if (field.value.length >= 5) {
            if (field.classList.contains("is-danger")) {
                field.classList.replace("is-danger", "is-success")
                return true;
            } else {
                field.classList.add("is-success");
                return true;
            }
        } else {
            if (field.classList.contains("is-success")) {
                field.classList.replace("is-success", "is-danger")
                return false;
            } else {
                field.classList.add("is-danger");
                return false;
            }
        }
    }

    function validateFieldLength(field, l) {
        /**
         * User field validation */
        if (field.value.length >= l) {
            if (field.classList.contains("is-danger")) {
                field.classList.replace("is-danger", "is-success")
                return true;
            } else {
                field.classList.add("is-success");
                return true;
            }
        } else {
            if (field.classList.contains("is-success")) {
                field.classList.replace("is-success", "is-danger")
                return false;
            } else {
                field.classList.add("is-danger");
                return false;
            }
        }
    }

    function generateUrlSafe32() {
        let characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_';
        let result = '';
        let charactersLength = characters.length;
        for (let i = 0; i < 32; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        document.getElementById("api_key").value = result;
    }

    function changeInterim(value) {
        document.getElementById("predictions").disabled = value
    }

    function addRowToTable() {
        // columnSize+=1;
        let columnSize = +document.getElementById("rowIntervalSize").value;
        if (columnSize === 0) {
            document.getElementById("rowIntervalSize").classList.add("is-danger")
            return;
        } else {
            document.getElementById("rowIntervalSize").classList.remove("is-danger")
        }
        columnSize += 1;
        // Get reference to table body
        var tbody = document.getElementById('table');

        // Create new row element
        var newRow = document.createElement('div');

        let max = tbody.children.length + 1;
        for (let i = 0; i < tbody.children.length; i++) {
            const child = tbody.children[i];
            const number = +child.id.split("_");
            if (number[2] === columnSize) {
                if (number[1] > max) {
                    max = number[1] + 1;
                }
            }
        }
        let itemsSize = ((max + 1) + '_result_' + (columnSize));
        newRow.id = itemsSize;
        newRow.classList.add("criteria")

        // Loop to create cells and inputs for each column
        for (var i = 0; i < columnSize; i++) {
            // Create new cell element
            var cell = document.createElement('div');

            // Create new div element with radio inputs
            var radioDiv = document.createElement('div');
            radioDiv.classList.add('field');
            radioDiv.classList.add('control');
            radioDiv.classList.add('flex');
            radioDiv.classList.add('flex-direction-column');
            radioDiv.classList.add('py-2');

            // Create radio inputs and labels
            for (var j = 0; j < 3; j++) {
                var childRadioDiv = document.createElement('div');
                childRadioDiv.classList.add('flex');
                childRadioDiv.classList.add('flex-direction-row');
                childRadioDiv.classList.add('flex-align-center');
                childRadioDiv.classList.add('mb-10');
                if (j === 0) {
                    var tag = document.createElement('span');
                    tag.classList.add("tag")
                    tag.classList.add(((i + 1) !== columnSize) ? 'is-success' : 'is-warning')
                    tag.classList.add("mb-1")
                    tag.textContent = (i + 1) !== columnSize ? 'Interval ' + (i + 1) : 'Result';
                    childRadioDiv.appendChild(tag);
                } else {
                    var radioInput = document.createElement('input');
                    radioInput.type = 'radio';
                    radioInput.name = (i + 1) !== columnSize ? ((max + 1) + '_interval_' + (i + 1)) : ((max + 1) + '_result_' + (columnSize));
                    radioInput.value = (j === 1) ? 'True' : 'False';
                    if (j === 1) {
                        radioInput.checked = true;
                    }

                    var label = document.createElement('span');
                    label.classList.add('pl-2');
                    label.textContent = (j === 1) ? 'Human' : 'Voicemail';

                    // Append radio input and label to radio div
                    childRadioDiv.appendChild(radioInput);
                    childRadioDiv.appendChild(label);
                }
                radioDiv.appendChild(childRadioDiv);
            }

            // Append radio div to cell
            cell.appendChild(radioDiv);

            // Append cell to row
            newRow.appendChild(cell);
        }

        let actionDivCol = document.createElement("div");
        let actionDivField = document.createElement("div");

        actionDivField.classList.add("field");

        let childActionDivField = document.createElement('div');
        childActionDivField.classList.add('control');
        childActionDivField.classList.add('py-2');
        childActionDivField.classList.add('flex');
        childActionDivField.classList.add('flex-direction-column');
        childActionDivField.classList.add('flex-align-center');

        let actionHeadingDiv = document.createElement("div");
        actionHeadingDiv.classList.add('flex');
        actionHeadingDiv.classList.add('flex-direction-row');
        actionHeadingDiv.classList.add('is-align-items-center');

        let actionHeadingSpan = document.createElement("span");
        actionHeadingSpan.classList.add("tag");
        actionHeadingSpan.classList.add("is-danger");
        actionHeadingSpan.classList.add("mb-1");

        actionHeadingDiv.append(actionHeadingSpan);

        let actionContentDiv = document.createElement("div");
        actionContentDiv.classList.add('is-flex');
        actionContentDiv.classList.add('is-flex-direction-row');
        actionContentDiv.classList.add('is-align-items-center');

        let actionRemove = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        var path1 = document.createElementNS("http://www.w3.org/2000/svg", 'path');
        actionRemove.setAttribute("width", "36");
        actionRemove.setAttribute("height", "36");
        actionRemove.setAttribute("viewBox", "0 0 36 36");
        actionRemove.setAttribute("fill", "none");
        actionRemove.classList.add("pointer")
        path1.setAttribute("d", "M12.5 14.5447H23.5M13.1875 14.5447L13.875 23.2113C13.875 23.5944 14.0199 23.9618 14.2777 24.2327C14.5356 24.5036 14.8853 24.6558 15.25 24.6558H20.75C21.1147 24.6558 21.4644 24.5036 21.7223 24.2327C21.9801 23.9618 22.125 23.5944 22.125 23.2113L22.8125 14.5447M15.9375 14.5447V12.378C15.9375 12.1864 16.0099 12.0027 16.1389 11.8673C16.2678 11.7319 16.4427 11.6558 16.625 11.6558H19.375C19.5573 11.6558 19.7322 11.7319 19.8611 11.8673C19.9901 12.0027 20.0625 12.1864 20.0625 12.378V14.5447M16.625 18.1558L19.375 21.0447M19.375 18.1558L16.625 21.0447");
        path1.setAttribute("stroke", "#00475A");
        path1.setAttribute("stroke-width", "1.33333");
        path1.setAttribute("stroke-linecap", "round");
        path1.setAttribute("stroke-linejoin", "round");

        actionRemove.appendChild(path1);

        actionRemove.addEventListener("click", () => removeInterim(`${itemsSize}`))

        actionContentDiv.append(actionRemove);

        childActionDivField.appendChild(actionHeadingDiv);
        childActionDivField.appendChild(actionContentDiv);

        actionDivField.appendChild(childActionDivField);
        actionDivCol.appendChild(actionDivField);

        newRow.appendChild(actionDivCol)
        // newRow.innerHTML +=`
        //     <td>
        //         <div class="field">
        //             <div class="control py-2 is-flex is-flex-direction-column is-align-items-center">
        //                 <div class="is-flex is-flex-direction-row is-align-items-center">
        //                     <span class="tag is-danger mb-1">Action</span>
        //                 </div>
        //                 <div class="is-flex is-flex-direction-row is-align-items-center">
        //                     <i class="fa-solid fa-trash" onclick="removeInterim('${((tbody.children.length + 1) + '_result_' + (columnSize))}')"></i>
        //                 </div>
        //             </div>
        //         </div>
        //     </td>
        // `

        // Append new row to table body
        tbody.appendChild(newRow);
    }

    function parseRows(criteria) {
        console.log(criteria)
        criteria = criteria.replaceAll('&#34;', '"');
        let data = JSON.parse(criteria);
        let intervals = {};

        let results = {};
        let tbody = document.getElementById('table');

        // Group keys by suffix
        for (const key in data) {
            if (data.hasOwnProperty(key)) {
                const suffix = key.split('_')[1];
                if (suffix.startsWith('interval')) {
                    intervals[key] = data[key];
                } else if (suffix.startsWith('result')) {
                    results[key] = data[key];
                }
            }
        }
        let html = '';

        // Generate rows based on the result keys
        for (const resultKey in results) {
            html = ''
            if (results.hasOwnProperty(resultKey)) {
                html += '<div id="' + resultKey + '" class="criteria">';
                let row = +resultKey.split("_").shift();
                for (const intervalKey in intervals) {
                    if (intervals.hasOwnProperty(intervalKey) && intervalKey.startsWith(row.toString())) {
                        const interval = intervalKey.split("_").pop()
                        html += `
                            <div>
                                <div class="field">
                                    <div class="control py-2 is-flex is-flex-direction-column">
                                        <div class="is-flex is-flex-direction-row is-align-items-center mb-10">
                                            <span class="tag is-success mb-1">Interval ${interval}</span>
                                        </div>
                                        <div class="is-flex is-flex-direction-row is-align-items-center mb-10">
                                            <input type="radio" name="${intervalKey}" value="True" ${data[intervalKey] === 'True' ? 'checked' : ''}>
                                            <span class="pl-2">Human</span>
                                        </div>
                                        <div class="is-flex is-flex-direction-row is-align-items-center">
                                            <input type="radio" name="${intervalKey}" value="False" ${data[intervalKey] === 'False' ? 'checked' : ''}>
                                            <span class="pl-2">Voicemail</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `
                    <div>
                        <div class="field">
                            <div class="control py-2 is-flex is-flex-direction-column">
                                <div class="is-flex is-flex-direction-row is-align-items-center mb-10">
                                    <span class="tag is-warning mb-1">Result</span>
                                </div>
                                <div class="is-flex is-flex-direction-row is-align-items-center mb-10">
                                    <input type="radio" name="${resultKey}" value="True" ${data[resultKey] === 'True' ? 'checked' : ''}>
                                    <span class="pl-2">Human</span>
                                </div>
                                <div class="is-flex is-flex-direction-row is-align-items-center">
                                    <input type="radio" name="${resultKey}" value="False" ${data[resultKey] === 'False' ? 'checked' : ''}>
                                    <span class="pl-2">Voicemail</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                html += `
                    <td>
                        <div class="field">
                            <div class="control py-2 is-flex is-flex-direction-column is-align-items-center">
                                <div class="is-flex is-flex-direction-row is-align-items-center">
                                    <span class="tag is-danger mb-1"></span>
                                </div>
                                <div class="is-flex is-flex-direction-row is-align-items-center">
                                    <svg  onclick="removeInterim('${resultKey}')" class="pointer" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_1_1127)">
                                        <path d="M12.5 14.5447H23.5M13.1875 14.5447L13.875 23.2113C13.875 23.5944 14.0199 23.9618 14.2777 24.2327C14.5356 24.5036 14.8853 24.6558 15.25 24.6558H20.75C21.1147 24.6558 21.4644 24.5036 21.7223 24.2327C21.9801 23.9618 22.125 23.5944 22.125 23.2113L22.8125 14.5447M15.9375 14.5447V12.378C15.9375 12.1864 16.0099 12.0027 16.1389 11.8673C16.2678 11.7319 16.4427 11.6558 16.625 11.6558H19.375C19.5573 11.6558 19.7322 11.7319 19.8611 11.8673C19.9901 12.0027 20.0625 12.1864 20.0625 12.378V14.5447M16.625 18.1558L19.375 21.0447M19.375 18.1558L16.625 21.0447" stroke="#00475A" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_1_1127">
                                        <rect width="16" height="16" fill="white" transform="translate(10 10.0044)"/>
                                        </clipPath>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                html += '</div>';
                tbody.innerHTML += html;
            }
        }
    }

    function removeInterim(key) {
        document.getElementById(key).remove()
    }

    const criteria = "{{ user.recognition.prediction_criteria|string }}"
    parseRows(criteria)

    function saveForm() {
        event.preventDefault();
        validateUserForm();
    }
    function toggleUserActive(newValue) {
        const activeSpan = document.getElementById('toggleActive');
        if (newValue) {
            activeSpan.innerHTML = `
                <span onclick="toggleUserActive(false)">
                    {% include 'header/icons/icon-square.html' %}
                    <input type="hidden" id="activeNotChecked" name="active" value="False">
                </span>`;
        } else {
            activeSpan.innerHTML = `
                <span onclick="toggleUserActive(true)">
                    {% include 'header/icons/icon-square-checked.html' %}
                    <input type="hidden" id="activeChecked" name="active" value="True">
                </span>`;
        }
    }
</script>
</body>
</html>